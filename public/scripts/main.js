// Generated by CoffeeScript 1.6.3
(function() {
  var fetch, renderSubject, renderSubjectList, updateSubjectList;

  fetch = function(trap) {
    var baseUrl, query, request;
    baseUrl = "https://the-zooniverse.cartodb.com/api/v2/sql?q=";
    query = "" + baseUrl + "select * from serengeti where site='" + trap + "' order by captured_at limit 3";
    query = encodeURI(query);
    query = query.replace(/\+/g, '%2B');
    request = $.get("" + query);
    return request;
  };

  renderSubject = function(subject) {
    var i, img, imgSrc, _i, _len, _ref;
    $('#captured_at').html("Captured at: " + (moment(subject.captured_at).format('MMMM Do YYYY, h:mm:ss a')));
    $('#subject-images').html("");
    $('#switch-image').html("");
    _ref = subject.locations;
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      imgSrc = _ref[i];
      img = new Image;
      img.src = imgSrc;
      $('#subject-images').append(img);
      $('#switch-image').append("<button value=\"" + i + "\">" + (i + 1) + "</button>");
    }
    return $('#subject-images').children().first().css('z-index', 1);
  };

  renderSubjectList = function(subjects) {
    var i, subject, _i, _len, _results;
    _results = [];
    for (i = _i = 0, _len = subjects.length; _i < _len; i = ++_i) {
      subject = subjects[i];
      _results.push($('#subject-list').append("<option value=\"" + i + "\">" + (moment(subject.captured_at).format('MMMM Do YYYY, h:mm:ss a')) + "</option>"));
    }
    return _results;
  };

  updateSubjectList = function(i) {
    $('#subject-list option:selected').removeAttr('selected');
    return $("#subject-list option:nth-child(" + (i + 1) + ")").attr('selected', 'selected');
  };

  $(function() {
    var cameraTrap, request;
    if (location.hash === "") {
      return $('#app').html('Need to specify a trap!');
    } else {
      cameraTrap = location.hash.slice(1);
      request = fetch(cameraTrap);
      return request.done(function(data) {
        var currentSubject;
        if (data.rows.length) {
          currentSubject = 0;
          renderSubject(data.rows[currentSubject]);
          renderSubjectList(data.rows);
          $('#subject-list').change(function(_arg) {
            var currentTarget;
            currentTarget = _arg.currentTarget;
            currentSubject = parseInt(currentTarget.value);
            return renderSubject(data.rows[currentSubject]);
          });
          $('#switch-image').click('button', function(_arg) {
            var target;
            target = _arg.target;
            $('#subject-images').children().css('z-index', 0);
            return $('#subject-images').children(":nth-child(" + target.value + ")").css('z-index', 1);
          });
          return $('#navigation').click('button', function(_arg) {
            var target;
            target = _arg.target;
            switch (target.name) {
              case "previous":
                if (currentSubject === 0) {
                  currentSubject = data.rows.length - 1;
                } else {
                  currentSubject -= 1;
                }
                break;
              case "next":
                if (currentSubject === (data.rows.length - 1)) {
                  currentSubject = 0;
                } else {
                  currentSubject += 1;
                }
            }
            renderSubject(data.rows[currentSubject]);
            return updateSubjectList(currentSubject);
          });
        }
      });
    }
  });

}).call(this);
